# ブートローダ

実際のハードウェアに関する問題を取り扱う。

## リセット

電源投入時、リセットボタンが押された時、プログラムは `0x0000` 番地、`_reset` から開始される。

## 割り込み発生時の処理

- 割り込み信号が入力されると、クロックに同期して、PFC (Program Flow Controller) の Interrupt 入力が立ち下がる
  - ここで同期するクロックは、CPU 本体とは逆相のクロックである
  - PC がカウントアップする半クロック前に、次に割り込みが入るか決定する
  - 割り込み信号入力部は、CSR (Controll Status Registor) の IEN (Inturrupt ENable) ビットと AND をとっている
  - すなわち、IEN=1 のときだけ、割り込み入力を受け付ける
  - これにより、ユーザプログラムは割り込み禁止・割り込み許可を制御できる
- 割り込み入力を受け付けると、PFC は ROM のかわりに `jump ira zero _intr` を発行する
  - 戻りアドレスは、IRA(Interrupt Return Address) レジスタに保存される
  - このレジスタは、ユーザプログラムでの使用は推奨されない
    - というかいつ割り込みが入って値が変わるかわからない
    - IEN と組み合わせて変なことができるかも
- `_intr:` には、割り込み処理のエピローグを書く
  - 割り込みは、関数呼び出しと違って、レジスタを全部退避する必要がある
- 割り込みの要因によって異なる割り込み番号は、IID (Interrupt ID) レジスタにある
- 各割り込み処理の本体は `_intrx:`
- 割り込み処理が終わったら、割り込みのプロローグ `_iret:` にジャンプする
- レジスタを復元したら、`ira` に戻る

## プログラム開始前処理

- main 関数の前に、初期化を行う
- 初期化したら、main にジャンプする

## プログラム終了後処理

- CSR の CSTOP (Clock Stop) ビットを立てると、クロックを停止させることができる
- これは、main の return がないプログラムには関係ない
